name: "🎯 FINAL FIX: All Issues Resolved"

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  build-fixed:
    runs-on: ubuntu-latest
    name: "🎯 Build APK (All Issues Fixed)"
    
    steps:
    - name: "📥 Checkout Code"
      uses: actions/checkout@v3
      
    - name: "☕ Setup JDK 17"
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: "📱 Setup Android SDK"
      uses: android-actions/setup-android@v3
      
    - name: "🔧 Fix Build Configuration"
      run: |
        cd simple_app
        
        # Fix the build.gradle to match JDK requirements
        cat > app/build.gradle << 'EOF'
        plugins {
            id 'com.android.application'
            id 'org.jetbrains.kotlin.android'
        }
        
        android {
            namespace 'com.smartagent.simple'
            compileSdk 33
        
            defaultConfig {
                applicationId "com.smartagent.simple"
                minSdk 21
                targetSdk 33
                versionCode 1
                versionName "1.0"
            }
        
            buildTypes {
                release {
                    minifyEnabled false
                }
            }
            
            compileOptions {
                sourceCompatibility JavaVersion.VERSION_1_8
                targetCompatibility JavaVersion.VERSION_1_8
            }
            
            kotlinOptions {
                jvmTarget = '1.8'
            }
        }
        
        dependencies {
            implementation 'androidx.core:core-ktx:1.9.0'
        }
        EOF
        
        # Fix root build.gradle
        cat > build.gradle << 'EOF'
        buildscript {
            repositories {
                google()
                mavenCentral()
            }
            dependencies {
                classpath 'com.android.tools.build:gradle:7.4.0'
                classpath 'org.jetbrains.kotlin:kotlin-gradle-plugin:1.7.10'
            }
        }
        
        allprojects {
            repositories {
                google()
                mavenCentral()
            }
        }
        
        task clean(type: Delete) {
            delete rootProject.buildDir
        }
        EOF
        
    - name: "🛠️ Make Gradlew Executable"
      run: |
        cd simple_app
        chmod +x gradlew
        
    - name: "🧹 Clean Build"
      run: |
        cd simple_app
        ./gradlew clean --stacktrace --info
        
    - name: "🔨 Build APK"
      run: |
        cd simple_app
        ./gradlew assembleDebug --stacktrace --info
        
    - name: "📦 Upload APK"
      uses: actions/upload-artifact@v3
      with:
        name: simple-agent-apk
        path: simple_app/app/build/outputs/apk/debug/*.apk
        
    - name: "✅ Success Notification"
      run: |
        echo "🎉 APK build successful!"
        ls -la simple_app/app/build/outputs/apk/debug/
